

services:
  # Redpanda - Kafka-compatible streaming platform
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: redpanda
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --memory 1G
      - --default-log-level=warn
    ports:
      - "18081:18081"  # Schema Registry
      - "18082:18082"  # REST Proxy
      - "19092:19092"  # Kafka API
      - "19644:9644"   # Admin API
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redpanda Console - Web UI for Kafka
  redpanda-console:
    image: redpandadata/console:v2.4.5
    container_name: redpanda-console
    ports:
      - "8080:8080"
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
          schemaRegistry:
            enabled: true
            urls: ["http://redpanda:8081"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml && /app/console'
    depends_on:
      redpanda:
        condition: service_healthy

  # ClickHouse - Time-series OLAP database
  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: clickhouse
    ports:
      - "8123:8123"   # HTTP interface
      - "9000:9000"   # Native interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./infra/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      CLICKHOUSE_DB: ieso
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - Caching layer for hot data
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Topic initialization (runs once)
  init-kafka:
    image: redpandadata/redpanda:v24.1.1
    container_name: init-kafka
    depends_on:
      redpanda:
        condition: service_healthy
    entrypoint: /bin/bash
    command: |
      -c '
      rpk topic create ieso.realtime.zonal-prices --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.zonal-demand --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.generator-output --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.fuel-mix --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.intertie-flow --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.adequacy --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.da-ozp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.da-intertie-lmp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.intertie-lmp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.weather.forecast --brokers redpanda:9092 -p 1 -r 1 || true
      echo "Topics created successfully"
      rpk topic list --brokers redpanda:9092
      '

volumes:
  redpanda_data:
  clickhouse_data:
  redis_data:
