services:
  # Redpanda - Kafka-compatible streaming platform (internal only)
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: redpanda
    restart: unless-stopped
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092
      - --advertise-kafka-addr internal://redpanda:9092
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --memory 512M
      - --default-log-level=warn
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 15s
      timeout: 5s
      retries: 5

  # ClickHouse - Time-series OLAP database (internal only, Caddy proxies)
  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: clickhouse
    restart: unless-stopped
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./infra/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      CLICKHOUSE_DB: ieso
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:?Set CLICKHOUSE_PASSWORD in .env.prod}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --password $$CLICKHOUSE_PASSWORD --query 'SELECT 1'"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Redis - Caching layer (internal only)
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 5

  # Topic initialization (runs once then exits)
  init-kafka:
    image: redpandadata/redpanda:v24.1.1
    container_name: init-kafka
    depends_on:
      redpanda:
        condition: service_healthy
    restart: "no"
    entrypoint: /bin/bash
    command: |
      -c '
      rpk topic create ieso.realtime.zonal-prices --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.zonal-demand --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.generator-output --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.fuel-mix --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.intertie-flow --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.adequacy --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.da-ozp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.hourly.da-intertie-lmp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.realtime.intertie-lmp --brokers redpanda:9092 -p 1 -r 1 || true
      rpk topic create ieso.weather.forecast --brokers redpanda:9092 -p 1 -r 1 || true
      echo "Topics created successfully"
      rpk topic list --brokers redpanda:9092
      '

  # IESO data producer (containerized)
  producer:
    build:
      context: ./producer
      dockerfile: Dockerfile
    container_name: producer
    restart: unless-stopped
    depends_on:
      redpanda:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      init-kafka:
        condition: service_completed_successfully
    environment:
      KAFKA_BROKER: redpanda:9092
      LOG_LEVEL: info

  # Caddy - Reverse proxy with automatic TLS
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      clickhouse:
        condition: service_healthy

volumes:
  redpanda_data:
  clickhouse_data:
  redis_data:
  caddy_data:
  caddy_config:
